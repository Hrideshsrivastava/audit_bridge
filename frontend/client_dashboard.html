<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Portal | AuditBridge</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <nav class="top-nav">
    <div class="nav-brand">AuditBridge <span style="font-weight:400; opacity:0.8">| Client Portal</span></div>
    <div>
      <span class="nav-info" id="clientNameDisplay">Loading...</span>
      <span onclick="logout()" class="logout-link" style="cursor: pointer;">Logout</span>
    </div>
  </nav>

  <div class="container">
    
    <div class="metrics-grid">
      <div class="metric-card">
        <span class="metric-label">Compliance Type</span>
        <span class="metric-sub" style="font-size: 1.2rem;" id="auditType">GST Audit</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Documents Required</span>
        <span class="metric-value" id="totalDocs">0</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Submitted</span>
        <span class="metric-value" id="submittedDocs">0</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Deadline</span>
        <span class="metric-sub" id="deadline">30 Sep 2026</span>
      </div>
    </div>

    <div class="content-card">
  <div class="list-header" style="grid-template-columns: 2fr 2fr 1.5fr 1fr 1fr;">
    <div>Document Name</div>
    <div>Description</div>
    <div>Due Date</div>
    <div>Status</div>
    <div style="text-align:center">Action</div>
  </div>

  <div id="docsList">
    <div style="padding: 2rem; text-align: center; color: #64748b;">
      <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
      Loading documents...
    </div>
  </div>
</div>

    <div class="footer">
      ¬© 2026 AuditBridge | Documents are visible only to you and your CA
    </div>

  </div>
  <script type="module" src="js/client_dashboard.js"></script>

  <!-- <script type="module">
    import { apiFetch } from "./js/api.js";
    import { requireAuth, logout } from "./js/auth_guard.js";

    requireAuth();
    window.logout = logout;

    let uploadingDocuments = new Set();

    async function loadDashboard() {
      try {
        const docs = await apiFetch("/client/documents");
        
        // Calculate Metrics
        const total = docs.length;
        const submitted = docs.filter(d => 
          d.status === 'uploaded' || d.status === 'verified' || d.status === 'submitted'
        ).length;
        
        // Update Top Cards
        document.getElementById("totalDocs").innerText = total;
        document.getElementById("submittedDocs").innerText = submitted;
        document.getElementById("clientNameDisplay").innerText = "Client Portal";

        // Set audit type if available
        if (docs.length > 0 && docs[0].financialYear) {
          document.getElementById("auditType").innerText = `FY ${docs[0].financialYear}`;
        }

        // Render the List
        const container = document.getElementById("docsList");
        container.innerHTML = "";

        if (total === 0) {
          container.innerHTML = `
            <div style="padding: 3rem; text-align: center; color: #64748b;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">No Documents Required</div>
              <p style="margin: 0;">Your CA will assign documents for you to upload.</p>
            </div>
          `;
          return;
        }

        docs.forEach(doc => {
          const row = document.createElement("div");
          row.className = "list-row";
          row.id = `doc-row-${doc.documentId}`;

          // Determine Status Styling
          let pillClass = "status-pending";
          let statusText = "Pending";
          
          if (doc.status === "uploaded" || doc.status === "submitted") { 
            pillClass = "status-uploaded"; 
            statusText = "Submitted"; 
          }
          if (doc.status === "verified") { 
            pillClass = "status-verified"; 
            statusText = "Verified"; 
          }
          if (doc.status === "rejected") { 
            pillClass = "status-pending"; 
            statusText = "Rejected"; 
          }

          // Determine Action Button
          let actionHtml = `<span style="color:#10b981; font-size:1.5rem; text-align:center; display:block;">‚úì</span>`;
          
          if (doc.status !== "verified") {
            const btnText = doc.status === "rejected" ? "Re-Upload" : "Upload";
            const btnId = `upload-btn-${doc.documentId}`;
            actionHtml = `
              <label class="btn-upload" id="${btnId}" style="cursor: pointer;">
                ${btnText}
                <input type="file" 
                       class="file-input-hidden" 
                       data-id="${doc.documentId}"
                       accept=".pdf,.jpg,.jpeg,.png">
              </label>
            `;
          }

          row.innerHTML = `
            <div class="doc-name">${doc.name}</div>
            <div class="doc-desc">Required for ${doc.financialYear || 'FY 2025-26'} Audit</div>
            <div><span class="status-pill ${pillClass}">${statusText}</span></div>
            <div style="text-align:center">${actionHtml}</div>
          `;
          container.appendChild(row);
        });

      } catch (err) {
        console.error("Dashboard error:", err);
        const container = document.getElementById("docsList");
        container.innerHTML = `
          <div style="padding: 2rem; text-align: center; color: #dc2626;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Failed to load dashboard</div>
            <p style="margin: 0; color: #64748b;">${err.message}</p>
            <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
          </div>
        `;
      }
    }

    // Enhanced File Upload Handler
    document.addEventListener("change", async (e) => {
      if (e.target.classList.contains("file-input-hidden")) {
        const file = e.target.files[0];
        const docId = e.target.dataset.id;
        
        if (!file || !docId) return;

        // Prevent duplicate uploads
        if (uploadingDocuments.has(docId)) {
          alert("Upload already in progress for this document");
          return;
        }

        // Validate file size (10MB limit)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
          alert("File size must be less than 10MB");
          e.target.value = "";
          return;
        }

        // Validate file type
        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
        if (!allowedTypes.includes(file.type)) {
          alert("Only PDF, JPG, and PNG files are allowed");
          e.target.value = "";
          return;
        }

        uploadingDocuments.add(docId);

        // Show uploading state
        const btn = document.getElementById(`upload-btn-${docId}`);
        const originalHTML = btn.innerHTML;
        btn.classList.add('loading');
        btn.innerHTML = '<span style="opacity:0">Uploading...</span>';
        btn.style.pointerEvents = 'none';

        try {
          const fd = new FormData();
          fd.append("file", file);

          const response = await fetch(`http://localhost:3000/client/document/${docId}/upload`, {
            method: "POST",
            headers: { 
              Authorization: `Bearer ${localStorage.getItem("token")}` 
            },
            body: fd
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Upload failed with status ${response.status}`);
          }

          // Success
          btn.classList.remove('loading');
          btn.style.background = '#10b981';
          btn.style.pointerEvents = 'none';
          btn.innerHTML = '‚úì Uploaded';
          
          // Refresh after short delay
          setTimeout(() => {
            window.location.reload();
          }, 1000);

        } catch (err) {
          console.error("Upload error:", err);
          
          // Restore button
          btn.classList.remove('loading');
          btn.innerHTML = originalHTML;
          btn.style.pointerEvents = 'auto';
          
          alert(`Upload failed: ${err.message}\n\nPlease try again or contact support if the problem persists.`);
          
          e.target.value = "";
        } finally {
          uploadingDocuments.delete(docId);
        }
      }
    });

    loadDashboard();
  </script> -->
</body>
</html>